name: Build (Windows) - Garmin SDK 6.4.1

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Garmin Connect IQ SDK 6.4.1
        run: |
          $url = "https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-win-6.4.1-2023-12-04-6cafd260d.zip"
          $zip = "$env:USERPROFILE\connectiq-sdk.zip"
          $dest = "$env:USERPROFILE\connectiq-sdk"
          Write-Host "Downloading SDK from: $url"
          Invoke-WebRequest -Uri $url -UseBasicParsing -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $dest -Force
          Write-Host "SDK extracted to $dest"
        shell: pwsh

      - name: Locate compiler (monkeyc / connectiq-cli)
        run: |
          $sdkRoot = "$env:USERPROFILE\connectiq-sdk"
          $exe = Get-ChildItem $sdkRoot -Recurse -Include "monkeyc", "connectiq" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exe) {
            Write-Error "No compiler executable found in SDK."
            exit 1
          }
          Write-Host "Using compiler: $($exe.FullName)"
          Add-Content -Path $env:GITHUB_PATH -Value (Split-Path $exe.FullName)
          Add-Content -Path $env:GITHUB_ENV -Value ("CONNECTIQ_EXE=" + $exe.FullName)
        shell: pwsh

      - name: Verify compiler
        run: |
          Write-Host "CONNECTIQ_EXE = $env:CONNECTIQ_EXE"
          & $env:CONNECTIQ_EXE --help
        shell: pwsh

      - name: Build project
        run: |
          Write-Host "Building project using: $env:CONNECTIQ_EXE"
          & $env:CONNECTIQ_EXE build
        shell: pwsh

      - name: Show bin/ contents
        run: |
          if (Test-Path ".\bin") {
            Write-Host "Contents of ./bin:"
            Get-ChildItem -Path .\bin -Recurse -Force | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "No ./bin folder found."
          }
        shell: pwsh

      - name: Upload .prg artifact
        uses: actions/upload-artifact@v4
        with:
          name: connectiq-prg
          path: bin/*.prg