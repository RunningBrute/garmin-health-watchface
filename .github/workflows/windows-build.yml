name: Build (Windows with SDK Manager)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Garmin SDK Manager
        run: |
          $sdkInstaller = "$env:USERPROFILE\GarminSDKManager.exe"
          Invoke-WebRequest -Uri "https://developer.garmin.com/downloads/connect-iq/sdk-manager/ConnectIQSDKManagerInstaller.exe" -OutFile $sdkInstaller
          Write-Host "Installing SDK Manager silently..."
          Start-Process -FilePath $sdkInstaller -ArgumentList "/S" -Wait
        shell: pwsh

      - name: Install latest SDK silently
        run: |
          $sdkManager = "$env:APPDATA\Garmin\ConnectIQ\SDKManager.exe"
          if (!(Test-Path $sdkManager)) {
            Write-Error "SDK Manager not found at $sdkManager"
            exit 1
          }

          Write-Host "Installing latest SDK (silent mode)..."
          & $sdkManager --install-latest -y
          Write-Host "Installed SDKs:"
          Get-ChildItem "$env:APPDATA\Garmin\ConnectIQ\Sdks"
        shell: pwsh

      - name: Find Connect IQ CLI or monkeyc
        run: |
          $sdkDir = Get-ChildItem "$env:APPDATA\Garmin\ConnectIQ\Sdks" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (!$sdkDir) { Write-Error "No SDKs found!" ; exit 1 }

          Write-Host "SDK in use: $($sdkDir.FullName)"
          $cliPath = Get-ChildItem $sdkDir.FullName -Recurse -Include "connectiq-cli.exe","monkeyc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (!$cliPath) { Write-Error "CLI or monkeyc not found in SDK!" ; exit 1 }

          Write-Host "Using compiler: $($cliPath.FullName)"
          echo "$($cliPath.DirectoryName)" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Add-Content -Path $env:GITHUB_ENV -Value ("CONNECTIQ_CLI=" + $cliPath.FullName)
        shell: pwsh

      - name: Verify Connect IQ CLI
        run: |
          Write-Host "CLI location: $env:CONNECTIQ_CLI"
          & $env:CONNECTIQ_CLI --help
        shell: pwsh

      - name: Build Garmin Project
        run: |
          Write-Host "Building project with CLI..."
          & $env:CONNECTIQ_CLI build
        shell: pwsh

      - name: Upload built .prg file
        uses: actions/upload-artifact@v4
        with:
          name: connectiq-build
          path: bin/*.prg