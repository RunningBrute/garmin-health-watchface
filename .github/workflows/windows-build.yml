name: Build (Windows) - Fallback SDK detection

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Garmin SDK Manager ZIP
        run: |
          $url = "https://developer.garmin.com/downloads/connect-iq/sdk-manager/connectiq-sdk-manager-windows.zip"
          $zip = "$env:USERPROFILE\connectiq-sdk-manager.zip"
          Write-Host "Downloading SDK Manager ZIP from: $url"
          Invoke-WebRequest -Uri $url -UseBasicParsing -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:USERPROFILE\connectiq-sdk-manager" -Force
          Write-Host "Extracted SDK Manager ZIP."
        shell: pwsh

      - name: Try installing latest SDK (silent)
        continue-on-error: true
        run: |
          $sdkMgr = Get-ChildItem "$env:USERPROFILE\connectiq-sdk-manager" -Recurse -Include "sdkmanager.exe" | Select-Object -First 1
          if (-not $sdkMgr) {
            Write-Error "sdkmanager.exe not found after extraction"
            exit 1
          }
          Write-Host "Running SDK Manager: $($sdkMgr.FullName)"
          & $sdkMgr.FullName --install-latest -y
          Write-Host "SDK installation attempted."
        shell: pwsh

      - name: Detect SDK folder (from install or bundle)
        id: find_sdk
        run: |
          $appDataSdk = Join-Path $env:APPDATA "Garmin\ConnectIQ\Sdks"
          $localSdk = Join-Path $env:USERPROFILE "connectiq-sdk-manager"
          Write-Host "Looking for SDK in: $appDataSdk and $localSdk"
          $sdkCandidates = @()

          if (Test-Path $appDataSdk) {
            Write-Host "Found folder in AppData, scanning..."
            $sdkCandidates += Get-ChildItem $appDataSdk -Directory -Recurse -ErrorAction SilentlyContinue
          }

          if (Test-Path $localSdk) {
            Write-Host "Scanning local manager folder for SDKs..."
            $sdkCandidates += Get-ChildItem $localSdk -Directory -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "sdk" -or $_.FullName -match "connectiq" }
          }

          if ($sdkCandidates.Count -eq 0) {
            Write-Error "No SDK folders found in AppData or extracted ZIP."
            exit 1
          }

          Write-Host "Possible SDK paths found:"
          $sdkCandidates | ForEach-Object { Write-Host " - $($_.FullName)" }

          $compiler = Get-ChildItem $sdkCandidates.FullName -Recurse -Include "connectiq-cli.exe","monkeyc.exe","connectiq.exe" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $compiler) {
            Write-Error "No compiler (connectiq-cli/monkeyc/connectiq) found in any detected SDK."
            exit 1
          }

          Write-Host "Using compiler: $($compiler.FullName)"
          Add-Content -Path $env:GITHUB_PATH -Value (Split-Path $compiler.FullName)
          Add-Content -Path $env:GITHUB_ENV -Value ("CONNECTIQ_EXE=" + $compiler.FullName)
        shell: pwsh

      - name: Verify compiler
        run: |
          Write-Host "CONNECTIQ_EXE: $env:CONNECTIQ_EXE"
          & $env:CONNECTIQ_EXE --help
        shell: pwsh

      - name: Build Garmin project
        run: |
          Write-Host "Building project using $env:CONNECTIQ_EXE"
          & $env:CONNECTIQ_EXE build
        shell: pwsh

      - name: Show bin/ and .prg
        run: |
          if (Test-Path ".\bin") {
            Write-Host "Contents of ./bin:"
            Get-ChildItem -Path .\bin -Recurse -Force | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "No ./bin folder found."
          }
          Write-Host "Searching for .prg files in workspace:"
          Get-ChildItem -Path . -Recurse -Filter *.prg -File -ErrorAction SilentlyContinue | ForEach-Object { Write-Host " -> " + $_.FullName }
        shell: pwsh

      - name: Upload .prg artifact
        uses: actions/upload-artifact@v4
        with:
          name: connectiq-prg
          path: bin/*.prg